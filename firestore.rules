rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
  
    // FunciÃ³n reutilizable para saber si el usuario es Admin.
    // Soporta el formato antiguo (role: "admin") y el nuevo (roles: ["admin", "player"])
    function isAdmin() {
      let userDoc = get(/databases/$(database)/documents/users/$(request.auth.uid));
      return userDoc != null && (
        userDoc.data.get('role', '') == "admin" || 
        ("admin" in userDoc.data.get('roles', []))
      );
    }

    // ğŸŸï¸ CANCHAS
    match /locations/{locationId} {

      // ğŸ‘€ Leer: cualquier usuario autenticado
      allow read: if request.auth != null;

      // â• Crear: solo admins
      allow create: if request.auth != null
        && isAdmin()
        && request.resource.data.createdBy == request.auth.uid;

      // âœï¸ Update: solo admins
      allow update: if request.auth != null
        && isAdmin();

      // âŒ Delete: nadie (por ahora)aaqPa
      allow delete: if false;
    }

  /* =========================
       ğŸ‘¤ USUARIOS - CORREGIDO
    ========================= */
    match /users/{userId} {
      // âœ… Leer: el propio usuario SIEMPRE puede leer su perfil
      allow read: if request.auth != null && request.auth.uid == userId;
      
      // âœ… Leer: admins pueden leer cualquier perfil
      allow read: if request.auth != null && isAdmin();
 
      // Crear: solo el propio usuario
      allow create: if request.auth != null && request.auth.uid == userId;
 
      // Update: usuario NO puede cambiar su rol o roles, admin puede todo
      allow update: if request.auth != null
        && (
          (
            request.auth.uid == userId
            // Verificamos que no intente modificar campos sensibles
            && (!request.resource.data.diff(resource.data).affectedKeys().hasAny(['role', 'roles']))
          )
          ||
          isAdmin()
        );
 
      // Delete: solo admins
      allow delete: if request.auth != null && isAdmin();
    }

    /* =========================
       âš½ PARTIDOS
    ========================= */
    match /matches/{matchId} {

      // ğŸ‘€ Leer
      allow read: if request.auth != null;

      // âœï¸ Crear: solo admins
      allow create: if request.auth != null
        && isAdmin()
        && request.resource.data.createdBy == request.auth.uid;

      // âœï¸ Update
      allow update: if request.auth != null
        && (
          // ğŸ‘‘ Admin global
          isAdmin()
          ||
          // âš½ Jugador (antes o despuÃ©s del update)
          (
            request.auth.uid in resource.data.playerUids
            || request.auth.uid in request.resource.data.playerUids
          )
        );

      allow delete: if false;
    }

  }
}
