rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
  
    // Funci√≥n reutilizable para saber si el usuario es Admin.
    // Soporta el formato antiguo (role: "admin") y el nuevo (roles: ["admin", "player"])
    function isAdmin() {
      let userDoc = get(/databases/$(database)/documents/users/$(request.auth.uid));
      return userDoc != null && (
        userDoc.data.get('role', '') == "admin" || 
        ("admin" in userDoc.data.get('roles', []))
      );
    }

    // üèüÔ∏è CANCHAS
    match /locations/{locationId} {

      // üëÄ Leer: cualquier usuario autenticado
      allow read: if request.auth != null;

      // ‚ûï Crear: solo admins
      allow create: if request.auth != null
        && isAdmin()
        && request.resource.data.createdBy == request.auth.uid;

      // ‚úèÔ∏è Update: solo admins
      allow update: if request.auth != null
        && isAdmin();

      // ‚ùå Delete: nadie (por ahora)aaqPa
      allow delete: if false;
    }

  /* =========================
       üë§ USUARIOS - CORREGIDO
    ========================= */
    match /users/{userId} {
      // ‚úÖ Leer: el propio usuario SIEMPRE puede leer su perfil
      allow read: if request.auth != null && request.auth.uid == userId;
      
      // ‚úÖ Leer: admins pueden leer cualquier perfil
      allow read: if request.auth != null && isAdmin();
 
      // Crear: solo el propio usuario
      allow create: if request.auth != null && request.auth.uid == userId;
 
      // Update: usuario NO puede cambiar su rol o roles, admin puede todo
      allow update: if request.auth != null
        && (
          (
            request.auth.uid == userId
            // Verificamos que no intente modificar campos sensibles
            && (!request.resource.data.diff(resource.data).affectedKeys().hasAny(['role', 'roles']))
          )
          ||
          isAdmin()
        );
 
      // Delete: solo admins
      allow delete: if request.auth != null && isAdmin();
    }

    /* =========================
       ‚öΩ PARTIDOS
    ========================= */
    match /matches/{matchId} {

      // üëÄ Leer
      allow read: if request.auth != null;

      // ‚úçÔ∏è Crear: solo admins
      allow create: if request.auth != null
        && isAdmin()
        && request.resource.data.createdBy == request.auth.uid;

      // ‚úèÔ∏è Update
      allow update: if request.auth != null
        && (
          // üëë Admin global
          isAdmin()
          ||
          // ‚öΩ Jugador (antes o despu√©s del update)
          (
            request.auth.uid in resource.data.playerUids
            || request.auth.uid in request.resource.data.playerUids
          )
        );

      allow delete: if false;
    }

    /* =========================
       üì¢ FEEDBACK
    ========================= */
    match /feedback/{feedbackId} {
      // Leer: solo admins
      allow read: if request.auth != null && isAdmin();
      
      // Crear: cualquier usuario autenticado puede crear su propio feedback
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      
      // Update/Delete: Nadie puede (o administrado desde panel de GCP)
      allow update, delete: if false;
    }

    /* =========================
       üîî NOTIFICACIONES IN-APP
    ========================= */
    match /notifications/{userId}/items/{notifId} {
      // Leer: solo el propio usuario
      allow read: if request.auth != null && request.auth.uid == userId;

      // Update: solo el propio usuario (para marcar como le√≠da)
      allow update: if request.auth != null && request.auth.uid == userId;

      // Crear/Borrar: solo Cloud Functions (admin SDK)
      allow create, delete: if false;
    }

  }
}
